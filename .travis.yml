dist: focal
language: python

before_install:
  # Install Vault
  - wget https://releases.hashicorp.com/vault/1.15.0/vault_1.15.0_linux_amd64.zip
  - unzip vault_1.15.0_linux_amd64.zip
  - sudo mv vault /usr/local/bin/

  # Install ngrok
  - wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
  - unzip ngrok-stable-linux-amd64.zip
  - sudo mv ngrok /usr/local/bin/

  # Configure ngrok token (add your token in Travis settings)
  - ngrok config add-authtoken $NGROK_AUTH_TOKEN

install:
  - pip install flask

before_script:
  # Start Vault dev server
  - vault server -dev -dev-root-token-id="root" > vault.log 2>&1 &
  - sleep 5
  - export VAULT_ADDR="http://127.0.0.1:8200"
  - export VAULT_TOKEN="root"

  # Create simple Flask API
  - |
    cat <<EOF > server.py
    from flask import Flask, request
    import subprocess, json

    app = Flask(__name__)
    SECRET_KEY = "yash123"

    @app.route("/vault/create", methods=["POST"])
    def create():
        if request.args.get("auth") != SECRET_KEY:
            return {"error": "unauthorized"}, 403

        key = request.json.get("key")
        value = request.json.get("value")

        cmd = ["vault", "kv", "put", "secret/myapp", f"{key}={value}"]
        out = subprocess.getoutput(" ".join(cmd))
        return {"status": "created", "output": out}

    @app.route("/vault/read")
    def read():
        cmd = ["vault", "kv", "get", "-format=json", "secret/myapp"]
        out = subprocess.getoutput(" ".join(cmd))
        return out

    if __name__ == "__main__":
        app.run(port=5000)
    EOF

script:
  # Start Flask server
  - python3 server.py > server.log 2>&1 &

  # Start ngrok tunnel
  - echo "Starting ngrok..."
  - nohup ngrok http 5000 --log=stdout > ngrok.log 2>&1 &

  # Wait until ngrok URL appears in logs
  - |
    echo "=== Waiting for ngrok URL ==="
    for i in {1..20}; do
      URL=$(grep -Eo "https://[a-z0-9.-]+.ngrok.io" ngrok.log | head -n 1)
      if [ ! -z "$URL" ]; then
        echo "=== NGROK PUBLIC URL ==="
        echo $URL
        break
      fi
      echo "Ngrok URL not ready yet ($i)..."
      sleep 2
    done

  # Keep Travis alive
  - while true; do echo "alive"; sleep 10; done
