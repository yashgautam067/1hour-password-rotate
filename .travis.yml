language: generic
dist: jammy

jobs:
  include:
    - stage: "Parallel System Password Rotation"
      name: "Rotate 10 users' passwords every 5 seconds"

      script:
        # create ten users (no password yet)
        - |
          echo "--- Creating 10 test users ---"
          for i in $(seq 1 10); do
            sudo useradd -m "user$i" || true
            echo "user$i:InitPass@123" | sudo chpasswd
          done

        # function that keeps changing one user's password
        - |
          rotate_pw() {
            local u=$1
            local start=$(date +%s)
            local duration=$((60))    # seconds; change to 3600 for 1 hour
            while [ $(($(date +%s) - start)) -lt $duration ]; do
              newpw=$(openssl rand -base64 12)
              echo "$u:$newpw" | sudo chpasswd
              sleep 5
            done
          }

        # launch 10 parallel rotations
        - |
          echo "--- Starting parallel password rotation ---"
          for i in $(seq 1 10); do
            rotate_pw "user$i" &
          done
          wait
          echo "--- Rotation period complete ---"
